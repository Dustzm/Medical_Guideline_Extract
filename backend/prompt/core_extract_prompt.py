# 构造提示词（使用您提供的思维链提示词）
def build_prompt(question, references, ev_definition):
    """
    临床问题知识抽取
    Args:
        question: <临床问题>原子
        references: 参考文献
        ev_definition: 推荐强度与证据质量定义

    Returns: 核心知识结构化

    """
    prompt = """
# 临床医学指南知识抽取专家系统

## 核心原则
- 逐步执行，每完成一个步骤后进行自我检查
- 确保每个实体只被抽取一次，避免重复
- 完整建立所有关联关系，不遗漏任何连接
- 在输出前进行完整性验证，确保无遗漏
- 特别注意处理范围式文献引用，确保每个文献都被正确解析和记录

## 抽取步骤

### 第一步：文档理解与结构分析
请先通读文档，理解整体结构，并标记出以下关键部分：
1. 临床问题部分（通常标记为"问题"、"临床"、"...症"等）
2. 推荐意见部分（通常标记为"推荐"、"建议"等）
3. 证据支持部分（通常在推荐意见后或专门的证据章节，有具体的证据等级）
4. 治疗方案部分（通常描述具体治疗方法和用药指导）
5. 参考文献部分（用于验证和补充文献引用信息）

### 第二步：临床问题抽取
对于每个推荐意见，请抽取以下信息：
- **property关系**：有…推荐意见、描述、涉及到、干预方法、结局指标
- **entityTag类型限定**：临床问题
- **property-valueTag类型限定**：有… 推荐意见 - 推荐意见，描述 - Literal，涉及到 - 目标人群，干预方法 - Literal，结局指标 - Literal
- **推荐意见抽取注意事项**：
    - 每个临床问题的推荐意见可能有多条，都需要抽取出来
- 为每个临床问题分配唯一ID，如果原文中有序号，则直接使用原文中内容（如"临床问题1"、"临床问题2"等）

### 第三步：推荐意见抽取
对于每个推荐意见，请抽取以下信息：
- **property关系**：推荐强度、证据质量等级、描述、"有… 药物治疗方案"或"有…操作治疗方案"、被… 支持
- **entityTag类型限定**：推荐意见
- **property-valueTag类型限定**：推荐强度-Literal，证据质量等级-Literal，描述-Literal，有…药物治疗方案-药物治疗方案，有…操作治疗方案-操作治疗方案，被…支持-证据
- **证据抽取注意事项**：
    - 每个临床问题会有多条证据支持，都需要抽取出来
- **治疗方案抽取注意事项**：
    - 每个推荐意见一般都有药物治疗方案或操作治疗方案，都需要抽取出来
- 为每个推荐意见分配唯一ID，根据临床问题ID进行分配（如临床问题1下的推荐意见为"推荐意见1-1"、"推荐意见1-2"等，格式为"推荐意见[临床问题编号]-[推荐意见序号]"）

### 第四步：证据抽取
对于支持每个推荐意见的证据，请按以下步骤进行：

1. **证据识别与去重**：
   - 仔细阅读推荐意见周围的文本，找出支持该推荐意见的所有证据
   - 为每个独特的证据创建唯一ID，要根据当前的推荐意见ID进行命名（如在临床问题1下的推荐问题1-1的证据，则为"证据1-1-1"、"证据1-1-2"等，格式为"证据[推荐意见编号]-[证据序号]"）
   - 检查证据描述是否重复，如果发现相同或高度相似的内容，只保留一个

2. **证据内容抽取**：
- **property关系**：描述、推荐等级、目标疾病、证据来源、证据类型、制订主体、发表年份
- **entityTag类型限定**：证据
- **property-valueTag类型限定**：描述-Literal，推荐等级-Literal，目标疾病-疾病，证据来源-文献资料，证据类型-临床研究设计类型，制订主体-组织机构，发表年份-dateTime
- **证据来源抽取注意事项**：
    - 每个证据会有多个证据来源，每个证据来源作为单独一条记录，抽取值为引用文献全称

3. **文献引用处理**：
   - **识别引用格式**：识别文本中的文献引用，特别是范围式引用（如[138-153，157-168]）
   - **解析引用范围**：
     * 对于连续范围（如138-153），展开为所有单独序号（138,139,140,...,153）
     * 对于不连续范围（如138-153，157-168），分别展开每个连续范围后合并
   - **验证引用完整性**：
     * 检查展开后的文献数量是否与原文中提到的数量一致（如"共纳入28项"）
     * 如果不一致，记录差异并优先以原文提到的数量为准
   - **创建单独文献记录**：
     * 为每个展开后的文献序号创建单独的"证据来源"记录
     * 如果参考文献列表可用，根据序号查找完整的文献信息
     * 如果参考文献列表不可用，保留文献序号作为标识

4. **证据唯一性验证**：
   - 比较所有已抽取的证据，确保没有重复
   - 如果发现重复，合并为单一证据，并记录所有相关的推荐意见关联
   - **证据唯一性判断标准**：
     - 证据描述完全相同
     - 证据描述核心内容相同，仅表述方式略有不同
     - 同一研究引用但描述角度不同
     - 多个研究结果相似且来自同一研究团队
   - **证据合并规则**：
     - 保留最完整的证据描述
     - 多条证据来源时，每个证据来源单独作为一条记录
     - 保留最高证据质量评价
     - 保留最新的发表年份（如有多项研究）

### 第五步：治疗方案抽取
对于每个推荐意见相关的治疗方案，请抽取：
- **property关系**：选择用药、治疗方法、适应证、适用人群、有…临床操作、注意事项 
- **entityTag类型限定**：药物治疗方案，操作治疗方案
- **property-valueTag类型限定**：选择用药-药物，治疗方法-治法，适应证-临床所见/异常形态结构，适用人群-目标人群，有…临床操作 - 临床操作，注意事项-Literal
- **治疗方案抽取注意事项**：
    - 一般每条推荐意见只有药物治疗方案或操作治疗方案
    - 药物治疗方案中的property限定为：选择用药、治疗方法、适应证、适用人群
    - 操作治疗方案中的property限定为：有…临床操作、注意事项、适应证、适用人群
为每个治疗方案分配唯一ID，根据临床问题ID进行分配（如在临床问题1下，则为"...治疗方案1-1"、"...治疗方案1-2"等）

### 第六步：关系构建
请建立以下关系，特别注意避免重复关联：

1. **临床问题 → 推荐意见**：
   - 明确哪个临床问题包含哪些推荐意见
   - 使用格式：临床问题X → 推荐意见Y

2. **推荐意见 → 被证据支持**：
   - 明确哪个证据支持哪个推荐意见
   - 确保每个证据只被关联一次，即使它支持多个推荐意见
   - 使用格式：推荐意见X → 被证据Y支持

3. **推荐意见 → 包含治疗方案**：
   - 明确哪个推荐意见对应哪个治疗方案
   - 使用格式：推荐意见X → 包含治疗方案Y

4. **证据 → 来源文献**：
   - 明确证据的文献来源
   - 对于范围式引用，确保每个文献都有单独的关联
   - 使用格式：证据X → 来源文献Y

### 第七步：重复检查与修正
完成初步抽取后，执行以下检查：

1. **证据重复检查**：
   - 列出所有证据描述
   - 比较相似度，识别重复或高度相似的内容
   - 如果发现重复，合并为单一证据，并更新所有相关关系

2. **关系一致性检查**：
   - 确保没有重复的关系（如同一证据多次关联到同一推荐意见）
   - 确保所有关系都有对应的实体存在
   - 特别检查文献引用关系，确保每个范围式引用都被正确展开

3. **完整性验证**：
   - 确保每个推荐意见都有至少一个证据支持
   - 确保每个推荐意见都有对应的治疗方案
   - 确保每个证据都有明确的来源
   - 确保每个证据来源都有明确的证据类型，制定主体，发表年份
   - **文献引用完整性验证**（新增）：
     * 统计每个证据的文献来源数量
     * 对照原文中的引用描述（如"共纳入28项"），验证数量一致性
     * 检查所有范围式引用是否被正确展开为单独文献

### 第八步：中间输出与检查
在完成以下每个步骤后，请输出简要的完成情况报告：

#### 完成临床问题抽取后
推荐意见抽取完成报告：

- 抽取推荐意见数量：[数量]
- 推荐意见ID列表：[ID1, ID2, ...]
- 每个临床问题对应的推荐意见数量：[临床问题1: 数量, 临床问题2: 数量, ...]

#### 完成证据抽取后
证据抽取完成报告：
- 抽取证据数量：[数量]
- 证据ID列表：[ID1, ID2, ...]
- 证据去重情况：[发现重复X处，已合并]
- 每个推荐意见对应的证据数量：[推荐意见1: 数量, 推荐意见2: 数量, ...]
- **文献引用处理情况**（新增）：
  * 处理范围式引用数量：[数量]
  * 展开文献引用总数：[数量]
  * 文献引用验证结果：[验证通过/发现差异，具体说明]

#### 完成治疗方案抽取后
治疗方案抽取完成报告：
- 抽取治疗方案数量：[数量]
- 治疗方案ID列表：[ID1, ID2, ...]
- 每个推荐意见对应的治疗方案数量：[推荐意见1: 数量, 推荐意见2: 数量, ...]

## 格式化输出
### 输出要求核心要点
1. 每行六列：entity、property、value、entityTag、valueTag、level

2. 多值实体拆分为多行

3. 空值保留字段，内容留空

4. 严格从原文抽取，不编造内容

5. 完整输出所有内容，不省略

6. 仅输出抽取内容，不输出其他无关文字

7. 根据原文中的临床问题序号，决定临床问题、推荐意见、治疗方案及证据的编号

8. 开始输出时要输出临床问题、推荐意见、治疗方案及证据的基本信息，例如：

临床问题1	有…推荐意见	推荐意见1-1	临床问题	推荐意见	2
推荐意见1-1	有…药物治疗方案	药物治疗方案1-1	推荐意见	药物治疗方案	3
推荐意见1-1	被…支持	证据1-1-1	推荐意见	证据	3

9. **文献引用输出要求**（新增）：
   - 每个展开的文献引用必须作为单独的"证据来源"记录输出
   - 如果无法获取完整文献信息，保留文献序号作为标识
   - 在同一证据下的多个文献来源，按照序号顺序排列

7. 输出时按照以下输出顺序，每个临床问题后输出推荐意见和治疗方案，每个推荐意见后输出对应的证据，请注意在输出时不得遗漏，根据原文内容严格输出每个临床问题下的推荐意见、推荐意见下的证据，不得遗漏，以下仅为示例，在正式输出时需要注意数量：
    - 临床问题1
      - 推荐意见1-1
      - 治疗方案1-1
        - 证据1-1-1
        - ...
      - 推荐意见1-2
      - 治疗方案1-2
        - 证据1-2-1
        - 证据1-2-2
        - ...

### 输出顺序详解
为确保输出不遗漏，请严格按照以下顺序输出：
1. 首先输出主实体和所有顶级关系，例如：
   - 本指南	针对的临床问题	临床问题1	主实体	临床问题	1
2. 然后按临床问题顺序，依次输出每个临床问题的完整信息
3. 对于每个临床问题，先输出其属性，然后输出其包含的推荐意见
4. 对于每个推荐意见，先输出其属性，然后输出其包含的治疗方案和证据
5. 最后输出所有关系连接，特别是文献引用关系

不必输出entity、property、value、entityTag、valueTag、level这六个表头，直接输出内容即可

#### 输出示例
本指南	针对的临床问题	临床问题1	主实体	临床问题	1
临床问题1	有…推荐意见	推荐意见1-1	临床问题	推荐意见	2
临床问题1	描述	中成药单独使用或联合其他方法治疗低骨量患者，在改善骨密度值、调节骨转换指标、降低骨折风险、减少疼痛、提高生活质量、改善中医临床症状方面的中医辨证应用、有效性和安全性如何？	临床问题	Literal	2
临床问题1	涉及到	低骨量患者	临床问题	目标人群	2
临床问题1	干预方法	中成药单独使用或联合其他方法	临床问题	Literal	2
临床问题1	结局指标	改善骨密度值、调节骨转换指标、降低骨折风险、减少疼痛、提高生活质量、改善中医临床症状	临床问题	Literal	2
推荐意见1-1	推荐强度	弱推荐，弱推荐，强推荐，弱推荐，强推荐	推荐意见	Literal	3
推荐意见1-1	证据质量等级	C、C、C、B、B	推荐意见	Literal	3
推荐意见1-1	描述	对于骨量减少患者，强骨胶囊联合活性维生素D 6个月可升高腰椎骨密度值（2C）、升高总髋部骨密度值（2C）、减少中医症状积分（1C）；强骨胶囊单独使用3个月可减轻骨痛积分（2B）、减少中医症状积分（1B）。	推荐意见	Literal	3
推荐意见1-1	有…药物治疗方案	药物治疗方案1-1	推荐意见	药物治疗方案	3
推荐意见1-1	被…支持	证据1-1-1	推荐意见	证据	3
推荐意见1-1	被…支持	证据1-1-2	推荐意见	证据	3
药物治疗方案1-1	选择用药	强骨胶囊联合活性维生素D	药物治疗方案	药物	4
药物治疗方案1-1	治疗方法	使用条件：口服，用药频率3次/日，每次1粒。	药物治疗方案	治法	4
药物治疗方案1-1	适应证	具有补肾、强骨、止痛作用，适用于肾阳亏虚证，症见骨脆易折、腰背或四肢关节疼痛、畏寒肢冷或抽筋、下肢无力、夜尿频多、目眩。	药物治疗方案	临床所见 / 异常形态结构	4
药物治疗方案1-1	适用人群	骨量减少患者	药物治疗方案	目标人群	4
证据1-1-1	描述	1项RCT研究（试验组：40例，对照组：39例）结果显示：与抗OP药物（碳酸钙D3片+阿法骨化醇）比较，强骨胶囊联合抗OP药物（碳酸钙D3片+阿法骨化醇）可升高腰椎骨密度[MD=0.29，95%CI（0.19，0.39）]；升高总髋部骨密度[MD=0.17，95%CI（0.11，0.23）]；减少腰背四肢疼痛评分[MD=-2.22，95%CI（-2.77，-1.67）]；减少下肢无力评分[MD=-1.17，95% CI（-1.43，-0.91）]；减少畏寒肢冷评分[MD=-1.10，95% CI（-1.37，-0.83）]；减少抽筋评分[MD=-0.27，95% CI（-0.39，-0.15）]。	证据	Literal	4
证据1-1-1	推荐等级	弱推荐，弱推荐，强推荐	证据	Literal	4
证据1-1-1	目标疾病	骨质疏松症(OP)	证据	疾病	4
证据1-1-1	证据来源	季晶俊，陈晓宏，庞辉群，等. 强骨胶囊干预老年低骨量患者的临床疗效［J］. 中国中医骨伤科杂志，2015，23（9）：30-32，36.	证据	文献资料	4
证据1-1-1	证据类型	RCT研究	证据	临床研究设计类型	4
证据1-1-1	制订主体 	中国中医骨伤科杂志	证据	组织机构	4
证据1-1-1	发表年份	2015	证据	dateTime	4
证据1-1-2	描述	2项RCT研究（试验组：92例，对照组：90例）结果显示：与骨松宝颗粒比较，强骨胶囊单独使用可减少骨痛积分[I2 = 0%，MD=-1.32，95% CI（-2.05，-0.59）]；减少中医症状积分[I2 = 0%，MD=-2.15，95% CI（-3.41， -0.89）]；提高中医证候总积分有效率[I2=0%，RR= 1.16，95% CI（1.05，1.29）]。	证据	Literal	4
证据1-1-2	推荐等级	弱推荐，强推荐	证据	Literal	4
证据1-1-2	目标疾病	骨质疏松症(OP)	证据	疾病	4
证据1-1-2	证据来源	盛彤，田金洲，胡玉宁，等. 强骨胶囊治疗原发性骨量减少（肾阳虚证）的临床研究［J］. 中国医药学报，2002，17（7）： 413-415.	证据	文献资料	4
证据1-1-2	证据类型	RCT研究	证据	临床研究设计类型	4
证据1-1-2	制订主体 	中国医药学报	证据	组织机构	4
证据1-1-2	发表年份	2002	证据	dateTime	4
证据1-1-2	证据来源	谢雁鸣，王和鸣，沈霖，等. 强骨胶囊治疗原发性骨质疏松症（骨量减少）的临床研究［J］. 中国中医药信息杂志，2004，11（6）：482-486.	证据	文献资料	4
证据1-1-2	证据类型	RCT研究	证据	临床研究设计类型	4
证据1-1-2	制订主体 	中国中医药信息杂志	证据	组织机构	4
证据1-1-2	发表年份	2004	证据	dateTime	4
    """
    prompt = f"""
        {prompt}
        待抽取的文本：
        ==推荐强度与证据等级定义==
        {ev_definition}
        ==参考文献==
        {references}
        ==临床问题==
        {question}
        """
    return prompt